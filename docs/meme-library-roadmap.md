# AI 表情库项目路线图

> 技术栈：Golang + Qdrant + VLM + Text Embedding  
> 数据源：ChineseBQB（MVP）、Tenor API、爬虫（扩展）  
> 目标：快速跑通 MVP，同时预留多数据源扩展能力
> 备注：下文为早期规划示意，实际实现以当前仓库为准（Docker Compose 仅包含 API + Alloy，Qdrant/存储外部）。

---

## 一、整体架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           前端 (Web/App)                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌─────────────┐                 ┌─────────────┐
            │  文本搜索    │                 │  图片搜索    │
            │  (文搜图)    │                 │  (图搜图)    │
            └─────────────┘                 └─────────────┘
                    │                               │
                    └───────────────┬───────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         API Gateway (Gin)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 文本搜索    │  │ 图片搜索    │  │ 分类浏览    │  │ 管理接口    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌─────────────────────┐  ┌─────────────────┐  ┌─────────────────────┐
│   Search Service    │  │  Ingest Service │  │   VLM Service       │
│   (语义搜索核心)     │  │  (数据摄入编排)  │  │   (图片描述生成)     │
└─────────────────────┘  └─────────────────┘  └─────────────────────┘
          │                       │                       │
          │              ┌────────┴────────┐              │
          │              ▼                 ▼              ▼
          │    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
          │    │ Source Adapter  │  │ Source Adapter  │  │ Embedding       │
          │    │ (ChineseBQB)    │  │ (Tenor API)     │  │ Service         │
          │    └─────────────────┘  └─────────────────┘  │ (文本向量生成)   │
          │              │                 │              └─────────────────┘
          │              │    ┌────────────┘                      │
          │              ▼    ▼                                   │
          │    ┌─────────────────────────────────────┐            │
          │    │       Data Source Interface         │            │
          │    │  (统一数据源抽象层 - 可扩展)          │            │
          │    └─────────────────────────────────────┘            │
          │                                                        │
          ▼                                                        ▼
┌─────────────────────┐                     ┌─────────────────────────────┐
│       Qdrant        │◄────────────────────│   Text Embedding API        │
│   (向量数据库)       │                     │   (Jina/OpenAI)             │
└─────────────────────┘                     └─────────────────────────────┘
          │                                               ▲
          ▼                                               │
┌─────────────────────┐         ┌─────────────────────┐   │
│       SQLite        │         │    对象存储 (S3)     │   │
│   (元数据 + 去重)    │         │   (图片文件存储)     │   │
│ [生产环境:PostgreSQL]│         └─────────────────────┘   │
└─────────────────────┘                                   │
                                          ┌───────────────┘
                                          │
                                ┌─────────────────────┐
                                │   VLM API           │
                                │ (GPT-4o/Qwen-VL)    │
                                └─────────────────────┘
```

### 1.2 核心设计原则

**数据源抽象层**：所有数据源（ChineseBQB、Tenor API、爬虫）都实现统一接口，新增数据源只需实现该接口即可接入，无需修改核心逻辑。

**摄入与搜索分离**：数据摄入是后台异步任务，搜索是实时低延迟服务，两者独立扩展。

**VLM 描述 + Text Embedding 方案**：
- 预处理阶段：使用 VLM（如 GPT-4o mini）为每张图片生成语义描述，再通过 Text Embedding 模型生成向量
- 文本搜索：用户查询文本直接生成 Embedding，与预计算向量匹配
- 图片搜索：用户上传图片先过 VLM 生成描述，再生成 Embedding 进行匹配
- 优势：语义理解更深，搜索质量更高；劣势：预处理成本较高，图搜图延迟较大

**MVP 轻量化原则**：MVP 阶段使用 SQLite 替代 PostgreSQL，降低运维复杂度；待规模扩大后再迁移。

---

## 二、核心模块设计

### 2.1 数据源抽象层（关键扩展点）

定义统一的数据源接口，所有数据源适配器必须实现：

| 方法 | 说明 |
|------|------|
| `FetchBatch()` | 批量获取表情包（支持分页/游标） |
| `GetMetadata()` | 获取单个表情包的元数据 |
| `SupportsIncremental()` | 是否支持增量更新 |
| `GetSourceID()` | 返回数据源唯一标识 |

**MVP 阶段实现**：ChineseBQB Adapter（从 GitHub 仓库读取）

**预留扩展**：
- Tenor API Adapter
- Giphy API Adapter  
- 通用爬虫 Adapter（接收爬虫推送的数据）
- 用户上传 Adapter

### 2.2 摄入服务（Ingest Service）

负责编排数据从各数据源到存储层的完整流程：

```
数据源 → 下载图片 → 去重检查 → 存储图片 → 生成Embedding → 写入Qdrant → 写入元数据
```

**关键设计**：
- 使用 Go 的 Worker Pool 模式控制并发
- 每个步骤独立，支持断点续传
- 失败任务进入重试队列

### 2.3 VLM 服务（图片描述生成）

负责将表情包图片转换为语义描述文本，是搜索质量的关键。

**Prompt 设计建议**：
```
请用简洁的中文描述这张表情包的内容，包括：
1. 图片中的主体（人物、动物、卡通形象等）
2. 表情或动作
3. 图片上的文字（如果有）
4. 表达的情绪或场景
输出格式：一段 50-100 字的描述
```

**VLM 选型对比**：

| 方案 | 单图成本 | 延迟 | 质量 | 适用阶段 |
|------|----------|------|------|----------|
| GPT-4o mini | ~$0.00015 | ~2s | 优秀 | MVP 首选 |
| Qwen-VL (API) | ~¥0.001 | ~1s | 良好 | 国内部署 |
| Claude 3 Haiku | ~$0.00025 | ~1.5s | 优秀 | 高质量备选 |
| LLaVA (本地) | 服务器成本 | ~500ms | 良好 | 大规模自建 |

**MVP 方案**：使用 GPT-4o mini，5000 张图预处理成本约 $0.75

### 2.4 Text Embedding 服务

将 VLM 描述文本和用户查询转换为向量。

**选型对比**：

| 方案 | 延迟 | 成本 | 向量维度 | 适用阶段 |
|------|------|------|----------|----------|
| Jina Embeddings v3 | ~50ms | 免费 1M tokens/月 | 1024 | MVP 首选 |
| OpenAI text-embedding-3-small | ~100ms | $0.02/1M tokens | 1536 | 备选 |
| BGE-M3 (本地) | ~20ms | 服务器成本 | 1024 | 大规模 |

**MVP 方案**：使用 Jina Embeddings v3 Cloud API，免费额度足够 MVP

### 2.5 搜索服务

支持两种搜索模式：文本搜索（文搜图）和图片搜索（图搜图）。

#### 文本搜索流程（文搜图）
1. 接收用户输入的自然语言查询
2. 调用 Text Embedding 服务生成查询向量
3. 在 Qdrant 中执行相似度搜索，返回 TopK 结果
4. 从 SQLite 补充元数据（可选，Qdrant Payload 已含基础信息）
5. 返回结果（含图片 URL、相似度分数、标签等）

#### 图片搜索流程（图搜图）
1. 接收用户上传的图片
2. 调用 VLM 服务生成图片描述
3. 调用 Text Embedding 服务生成描述向量
4. 在 Qdrant 中执行相似度搜索，返回 TopK 结果
5. 返回结果

**图搜图优化策略**：
- 缓存：对上传图片计算 MD5，缓存 VLM 描述结果，相同图片无需重复调用
- 前端体验：显示「正在分析图片...」进度提示，预期延迟 1-3 秒

**Qdrant 配置建议**：
- Collection 使用余弦相似度（Cosine）
- 向量维度：1024（Jina Embeddings v3）
- 开启 HNSW 索引，ef=128, m=16
- Payload 存储：source_type, category, is_animated, tags, vlm_description

---

## 三、数据模型设计

### 3.1 数据库选型策略

| 阶段 | 数据库 | 理由 |
|------|--------|------|
| MVP (< 5万图) | SQLite | 简单、零运维、单文件部署 |
| 扩展期 (5-50万图) | PostgreSQL | 并发支持、复杂查询 |
| 规模化 (50万+) | PostgreSQL + 读写分离 | 性能扩展 |

**迁移策略**：使用 GORM 作为 ORM，支持 SQLite → PostgreSQL 无缝切换，只需修改连接字符串。

### 3.2 SQLite 表结构（MVP）

**memes 表（核心）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT (UUID) | 主键 |
| source_type | TEXT | 数据源类型（chinesebqb/tenor/crawler） |
| source_id | TEXT | 数据源内的原始ID |
| storage_key | TEXT | 对象存储路径 |
| original_url | TEXT | 原始来源URL |
| width | INTEGER | 宽度 |
| height | INTEGER | 高度 |
| format | TEXT | 格式（jpeg/png/gif/webp） |
| is_animated | INTEGER | 是否动图（0/1） |
| file_size | INTEGER | 文件大小（字节） |
| md5_hash | TEXT | MD5哈希（精确去重） |
| perceptual_hash | TEXT | 感知哈希（相似去重，可选） |
| qdrant_point_id | TEXT | Qdrant 中的向量ID |
| vlm_description | TEXT | VLM 生成的图片描述 |
| vlm_model | TEXT | 使用的 VLM 模型版本 |
| embedding_model | TEXT | 使用的 Embedding 模型版本 |
| tags | TEXT | 标签（JSON 数组格式） |
| category | TEXT | 分类 |
| status | TEXT | 状态（pending/active/failed） |
| created_at | TEXT | 入库时间（ISO8601） |
| updated_at | TEXT | 更新时间（ISO8601） |

**索引设计**：
```sql
CREATE UNIQUE INDEX idx_memes_source ON memes(source_type, source_id);
CREATE INDEX idx_memes_md5 ON memes(md5_hash);
CREATE INDEX idx_memes_status ON memes(status);
CREATE INDEX idx_memes_category ON memes(category);
```

**data_sources 表（数据源管理）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 数据源标识（主键） |
| name | TEXT | 显示名称 |
| type | TEXT | 类型（static/api/crawler） |
| config | TEXT | 配置信息（JSON 格式） |
| last_sync_at | TEXT | 上次同步时间 |
| last_sync_cursor | TEXT | 同步游标（支持增量） |
| is_enabled | INTEGER | 是否启用（0/1） |
| priority | INTEGER | 优先级 |

**ingest_jobs 表（摄入任务追踪）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT (UUID) | 任务ID |
| source_id | TEXT | 数据源 |
| status | TEXT | pending/running/completed/failed |
| total_items | INTEGER | 总数 |
| processed_items | INTEGER | 已处理数 |
| failed_items | INTEGER | 失败数 |
| started_at | TEXT | 开始时间 |
| completed_at | TEXT | 完成时间 |
| error_log | TEXT | 错误日志 |

### 3.3 Qdrant Collection 结构

**Collection**: `memes`

| 配置项 | 值 |
|--------|-----|
| 向量维度 | 1024（Jina Embeddings v3） |
| 距离度量 | Cosine |
| 索引类型 | HNSW (ef=128, m=16) |

**Payload 字段设计**：

| 字段 | 类型 | 用途 |
|------|------|------|
| meme_id | string | 关联 SQLite 主键 |
| source_type | string | 过滤数据源 |
| category | string | 分类过滤 |
| is_animated | bool | GIF 过滤 |
| tags | string[] | 标签过滤 |
| vlm_description | string | 描述文本（调试用） |
| storage_url | string | 图片 URL（直接返回，减少查库） |

**Payload 用于过滤**：搜索时可以附加条件，如「只搜索 GIF」或「只搜索某分类」。

**示例向量点结构**：
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "vector": [0.1, 0.2, ...],
  "payload": {
    "meme_id": "550e8400-e29b-41d4-a716-446655440000",
    "source_type": "chinesebqb",
    "category": "猫猫表情",
    "is_animated": false,
    "tags": ["猫", "无语", "可爱"],
    "vlm_description": "一只橘猫露出无语的表情，眼神呆滞",
    "storage_url": "https://cdn.example.com/memes/abc123.jpg"
  }
}
```

---

## 四、核心流程时序图

### 4.1 预处理（摄入）时序图

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Ingest  │  │  Source  │  │  Object  │  │   VLM    │  │Embedding │  │  Qdrant  │  │  SQLite  │
│ Service  │  │ Adapter  │  │ Storage  │  │ Service  │  │ Service  │  │          │  │          │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │             │             │
     │ 1. FetchBatch()           │             │             │             │             │
     │────────────>│             │             │             │             │             │
     │             │             │             │             │             │             │
     │ 2. 返回图片列表 [{url, id, category}]   │             │             │             │
     │<────────────│             │             │             │             │             │
     │             │             │             │             │             │             │
     │ 3. 下载图片 & 计算 MD5                  │             │             │             │
     │─────────────────────────────────────────────────────────────────────────────────>│
     │             │             │             │             │             │ 4. 查询 MD5 │
     │             │             │             │             │             │    是否存在 │
     │<─────────────────────────────────────────────────────────────────────────────────│
     │             │             │             │             │             │             │
     │ [如果已存在，跳过；如果不存在，继续]     │             │             │             │
     │             │             │             │             │             │             │
     │ 5. 上传图片到对象存储     │             │             │             │             │
     │────────────────────────────>│           │             │             │             │
     │             │             │             │             │             │             │
     │ 6. 返回 storage_key       │             │             │             │             │
     │<────────────────────────────│           │             │             │             │
     │             │             │             │             │             │             │
     │ 7. 调用 VLM 生成图片描述  │             │             │             │             │
     │─────────────────────────────────────────>│            │             │             │
     │             │             │             │             │             │             │
     │ 8. 返回描述文本                          │             │             │             │
     │    "一只橘猫露出无语表情，眼神呆滞"      │             │             │             │
     │<─────────────────────────────────────────│            │             │             │
     │             │             │             │             │             │             │
     │ 9. 调用 Embedding 生成向量               │             │             │             │
     │──────────────────────────────────────────────────────>│             │             │
     │             │             │             │             │             │             │
     │ 10. 返回向量 [1024 维]                   │             │             │             │
     │<──────────────────────────────────────────────────────│             │             │
     │             │             │             │             │             │             │
     │ 11. 写入向量到 Qdrant (含 Payload)       │             │             │             │
     │─────────────────────────────────────────────────────────────────────>│            │
     │             │             │             │             │             │             │
     │ 12. 返回 point_id                        │             │             │             │
     │<─────────────────────────────────────────────────────────────────────│            │
     │             │             │             │             │             │             │
     │ 13. 写入元数据到 SQLite                  │             │             │             │
     │─────────────────────────────────────────────────────────────────────────────────>│
     │             │             │             │             │             │             │
     │ 14. 确认写入成功                         │             │             │             │
     │<─────────────────────────────────────────────────────────────────────────────────│
     │             │             │             │             │             │             │

预处理耗时估算（单张图片）：
- Step 3-4: ~10ms (MD5 + 查库)
- Step 5-6: ~100ms (上传存储)
- Step 7-8: ~2000ms (VLM 推理，主要耗时)
- Step 9-10: ~50ms (Text Embedding)
- Step 11-14: ~20ms (写入)
- 总计: ~2.2s/张，5000张约 3 小时
```

### 4.2 文本搜索时序图（文搜图）

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Client  │  │   API    │  │Embedding │  │  Qdrant  │  │  SQLite  │
│          │  │ Gateway  │  │ Service  │  │          │  │ (可选)   │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │
     │ 1. POST /api/v1/search                  │             │
     │    {"query": "无语", "top_k": 20}       │             │
     │────────────>│             │             │             │
     │             │             │             │             │
     │             │ 2. 生成查询文本 Embedding  │             │
     │             │────────────>│             │             │
     │             │             │             │             │
     │             │ 3. 返回向量 [1024 维]      │             │
     │             │<────────────│             │             │
     │             │             │             │             │
     │             │ 4. 向量相似搜索            │             │
     │             │    (TopK=20, 可带过滤条件) │             │
     │             │────────────────────────────>│            │
     │             │             │             │             │
     │             │ 5. 返回结果                │             │
     │             │    [{point_id, score, payload}]         │
     │             │<────────────────────────────│            │
     │             │             │             │             │
     │             │ [可选] 6. 补充查询详细元数据             │
     │             │──────────────────────────────────────────>│
     │             │             │             │             │
     │             │ [可选] 7. 返回额外信息     │             │
     │             │<──────────────────────────────────────────│
     │             │             │             │             │
     │ 8. 返回搜索结果                          │             │
     │    [{url, score, description, tags}]    │             │
     │<────────────│             │             │             │
     │             │             │             │             │

响应时间预估：
- Step 2-3: ~50ms (Text Embedding)
- Step 4-5: ~30ms (Qdrant 向量搜索)
- Step 6-7: ~10ms (SQLite 查询，可选)
- 总计: ~100ms (P99 目标 < 200ms)
```

### 4.3 图片搜索时序图（图搜图）

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Client  │  │   API    │  │  Cache   │  │   VLM    │  │Embedding │  │  Qdrant  │
│          │  │ Gateway  │  │ (可选)   │  │ Service  │  │ Service  │  │          │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │             │
     │ 1. POST /api/v1/search/image            │             │             │
     │    {"image": "<base64>", "top_k": 20}   │             │             │
     │────────────>│             │             │             │             │
     │             │             │             │             │             │
     │             │ 2. 计算图片 MD5            │             │             │
     │             │────────────>│             │             │             │
     │             │             │             │             │             │
     │             │ 3. 查询缓存 (MD5 → 描述)   │             │             │
     │             │<────────────│             │             │             │
     │             │             │             │             │             │
     │ [缓存命中则跳到 Step 7]   │             │             │             │
     │             │             │             │             │             │
     │             │ 4. 调用 VLM 描述图片       │             │             │
     │             │─────────────────────────────>│           │             │
     │             │             │             │             │             │
     │             │ 5. 返回图片描述文本        │             │             │
     │             │    "一只猫咪露出无语表情"  │             │             │
     │             │<─────────────────────────────│           │             │
     │             │             │             │             │             │
     │             │ 6. 缓存描述 (MD5 → 描述)   │             │             │
     │             │────────────>│             │             │             │
     │             │             │             │             │             │
     │             │ 7. 生成描述文本的 Embedding│             │             │
     │             │──────────────────────────────────────────>│            │
     │             │             │             │             │             │
     │             │ 8. 返回向量 [1024 维]      │             │             │
     │             │<──────────────────────────────────────────│            │
     │             │             │             │             │             │
     │             │ 9. 向量相似搜索 (TopK=20)  │             │             │
     │             │─────────────────────────────────────────────────────────>│
     │             │             │             │             │             │
     │             │ 10. 返回结果               │             │             │
     │             │     [{point_id, score, payload}]        │             │
     │             │<─────────────────────────────────────────────────────────│
     │             │             │             │             │             │
     │ 11. 返回搜索结果                         │             │             │
     │     [{url, score, description, tags}]   │             │             │
     │<────────────│             │             │             │             │
     │             │             │             │             │             │

响应时间预估：
- Step 2-3: ~5ms (MD5 + 缓存查询)
- Step 4-5: ~1500ms (VLM 推理，缓存命中则跳过)
- Step 6: ~5ms (缓存写入)
- Step 7-8: ~50ms (Text Embedding)
- Step 9-10: ~30ms (Qdrant 搜索)
- 总计: ~1600ms (P99 目标 < 3s)
- 缓存命中: ~100ms
```

---

## 五、技术选型清单

### 5.1 后端技术栈

| 组件 | 选型 | 理由 |
|------|------|------|
| Web 框架 | Gin | 高性能、生态成熟 |
| ORM | GORM | 功能完善、支持 SQLite/PostgreSQL 无缝切换 |
| 配置管理 | Viper | 支持多格式、环境变量 |
| 日志 | Zap | 高性能结构化日志 |
| 任务队列 | Asynq (Redis) | Go 原生、轻量级（MVP 可选用简单协程池） |
| HTTP 客户端 | Resty | 链式调用、重试支持 |
| Qdrant 客户端 | go-qdrant (官方) | 官方维护 |

### 5.2 基础设施

| 组件 | MVP 选型 | 生产选型 | 备注 |
|------|----------|----------|------|
| 数据库 | SQLite | PostgreSQL 15+ | GORM 支持无缝迁移 |
| 向量数据库 | Qdrant | Qdrant (集群) | 开源、性能优秀 |
| 对象存储 | MinIO | S3 / 阿里云 OSS | MVP 用 MinIO 本地存储 |
| 缓存 | 内存 Map | Redis | MVP 阶段可不引入 Redis |
| 容器化 | Docker Compose | Kubernetes | MVP 阶段一键启动 |

### 5.3 外部 AI 服务

| 服务 | 用途 | MVP 方案 | 备选方案 |
|------|------|----------|----------|
| VLM API | 图片描述生成 | GPT-4o mini | Qwen-VL、Claude 3 Haiku |
| Text Embedding API | 向量生成 | Jina Embeddings v3（免费） | OpenAI text-embedding-3-small |
| 图片 CDN | 图片分发 | 直接用 MinIO | CloudFront / 阿里云 CDN |

---

## 六、目录结构规划

```
meme-library/
├── cmd/
│   ├── api/                    # API 服务入口
│   │   └── main.go
│   ├── ingest/                 # 摄入服务入口（CLI 工具）
│   │   └── main.go
│   └── worker/                 # 异步任务 Worker（可选）
│       └── main.go
│
├── internal/
│   ├── api/                    # API 层
│   │   ├── handler/            # HTTP 处理器
│   │   │   ├── search.go       # 搜索相关接口
│   │   │   ├── meme.go         # 表情包 CRUD
│   │   │   └── health.go       # 健康检查
│   │   ├── middleware/         # 中间件
│   │   └── router.go
│   │
│   ├── domain/                 # 领域模型
│   │   ├── meme.go             # 表情包实体
│   │   ├── source.go           # 数据源实体
│   │   └── job.go              # 任务实体
│   │
│   ├── service/                # 业务逻辑层
│   │   ├── search.go           # 搜索服务（文搜图 + 图搜图）
│   │   ├── ingest.go           # 摄入编排
│   │   ├── vlm.go              # VLM 图片描述服务
│   │   └── embedding.go        # Text Embedding 服务
│   │
│   ├── repository/             # 数据访问层
│   │   ├── meme_repo.go        # SQLite 表情包存储
│   │   ├── source_repo.go      # 数据源配置存储
│   │   ├── qdrant_repo.go      # Qdrant 向量操作
│   │   └── cache_repo.go       # VLM 描述缓存
│   │
│   ├── source/                 # 数据源适配器（扩展点）
│   │   ├── interface.go        # 统一接口定义
│   │   ├── chinesebqb/         # ChineseBQB 适配器
│   │   ├── tenor/              # Tenor API 适配器（预留）
│   │   ├── giphy/              # Giphy API 适配器（预留）
│   │   └── crawler/            # 爬虫数据接收器（预留）
│   │
│   ├── storage/                # 存储抽象
│   │   ├── interface.go
│   │   ├── minio.go
│   │   └── s3.go
│   │
│   └── pkg/                    # 工具包
│       ├── hash/               # MD5、感知哈希
│       ├── image/              # 图片处理（尺寸、格式、GIF 关键帧）
│       └── retry/              # 重试逻辑
│
├── data/                       # 本地数据目录（.gitignore）
│   ├── memes.db                # SQLite 数据库文件
│   └── cache/                  # VLM 描述缓存
│
├── configs/                    # 配置文件
│   ├── config.yaml             # 主配置
│   └── config.example.yaml     # 示例配置
│
├── deployments/                # 部署相关
│   ├── docker-compose.yml      # API + Alloy（Qdrant/存储外部）
│   └── Dockerfile
│
├── scripts/                    # 脚本
│   └── ingest_chinesebqb.sh    # ChineseBQB 数据导入脚本
│
├── go.mod
├── go.sum
└── docs/README.md
```

---

## 七、分阶段实施计划

### 第一阶段：MVP 基础搭建（第 1-2 周）

**目标**：跑通「ChineseBQB 导入 → 语义搜索」完整链路

**Week 1：基础设施 + 数据模型**

| 任务 | 产出 | 优先级 |
|------|------|--------|
| 搭建 Docker Compose 环境 | API + Alloy Compose（Qdrant/存储外部） | P0 |
| 初始化 Go 项目结构 | 按目录规划创建骨架 | P0 |
| 实现 SQLite 数据模型 | memes、data_sources、ingest_jobs 三张表 + GORM | P0 |
| 实现存储抽象层 | MinIO 上传/下载/URL 生成 | P0 |
| 配置管理 | Viper 读取 config.yaml + 环境变量 | P1 |

**Week 2：VLM + Embedding + 搜索**

| 任务 | 产出 | 优先级 |
|------|------|--------|
| 实现数据源接口定义 | source/interface.go | P0 |
| 实现 ChineseBQB Adapter | 从 GitHub 拉取图片列表、下载图片 | P0 |
| 实现 VLM 服务 | 对接 GPT-4o mini API，生成图片描述 | P0 |
| 实现 Text Embedding 服务 | 对接 Jina Embeddings v3 API | P0 |
| 实现摄入流程 | 下载 → 存储 → VLM 描述 → Embedding → 写入 Qdrant | P0 |
| 实现文本搜索 API | POST /api/v1/search 接口 | P0 |
| 基础去重 | MD5 哈希去重 | P1 |

**MVP 里程碑验收**：
- [ ] 成功导入 ChineseBQB 全部 5,791 张表情包（含 VLM 描述）
- [ ] 输入「无语」返回相关表情包
- [ ] 输入「开心猫猫」返回相关表情包
- [ ] 文本搜索延迟 < 200ms

---

### 第二阶段：功能完善（第 3-4 周）

**目标**：完善核心功能，支持图搜图

**Week 3：图搜图 + 搜索增强**

| 任务 | 产出 | 优先级 |
|------|------|--------|
| 实现图片搜索 API | POST /api/v1/search/image（图搜图） | P0 |
| VLM 描述缓存 | MD5 → 描述 缓存，避免重复调用 VLM | P0 |
| 分类浏览 API | GET /api/v1/categories, GET /api/v1/memes?category=xxx | P0 |
| 标签过滤搜索 | 支持 Qdrant Payload 过滤 + 向量搜索组合 | P1 |
| GIF 特殊处理 | 提取关键帧供 VLM 描述 | P1 |
| 搜索结果分页 | 游标分页，支持无限滚动 | P1 |

## 八、关键技术决策记录

### 8.1 为什么选择 Qdrant 而不是 Milvus/Pinecone？

| 对比项 | Qdrant | Milvus | Pinecone |
|--------|--------|--------|----------|
| 部署复杂度 | 单二进制，极简 | 依赖多，复杂 | 托管服务 |
| Go SDK | 官方支持 | 社区维护 | 官方支持 |
| 资源占用 | 轻量 | 较重 | N/A |
| 成本 | 开源免费 | 开源免费 | $70+/月 |
| 适合阶段 | MVP → 中等规模 | 大规模 | 快速验证 |

**结论**：MVP 阶段 Qdrant 的简洁性和 Go 支持是最佳选择。

### 8.2 为什么选择 VLM 描述 + Text Embedding 而不是 CLIP？

| 对比项 | VLM + Text Embedding | CLIP 多模态 |
|--------|----------------------|-------------|
| 语义理解深度 | 深，VLM 理解场景和情绪 | 中等，端到端学习 |
| 文搜图质量 | 高 | 中等 |
| 图搜图延迟 | 高（需过 VLM） | 低（直接 Embedding） |
| 预处理成本 | 高（VLM 推理） | 低 |
| 中文支持 | 优秀（用中文 VLM） | 取决于模型 |

**结论**：表情包搜索更注重语义匹配（如「无语」「尴尬」等抽象概念），VLM 描述方案质量更高。图搜图延迟可通过缓存优化。

### 8.3 为什么 MVP 用 SQLite 不用 PostgreSQL？

| 对比项 | SQLite | PostgreSQL |
|--------|--------|------------|
| 部署复杂度 | 零，单文件 | 需独立服务 |
| 并发支持 | 有限（写锁） | 优秀 |
| 运维成本 | 零 | 需要备份、监控 |
| 功能 | 基础 SQL | JSONB、数组、全文检索 |
| 迁移成本 | → PostgreSQL 简单 | - |

**结论**：MVP 阶段数据量小（5000 张），并发低，SQLite 足够。使用 GORM 可以无缝迁移到 PostgreSQL。

### 8.4 为什么摄入和搜索分离为两个服务？

- **资源隔离**：摄入是 CPU/IO 密集型（下载、哈希计算），搜索是低延迟要求
- **独立扩展**：搜索需要水平扩展应对流量，摄入按需运行
- **部署灵活**：可以在低峰期运行摄入任务

---
