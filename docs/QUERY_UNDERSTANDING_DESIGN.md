# Query Understanding æ¨¡å—è®¾è®¡æ–‡æ¡£

> ç»Ÿä¸€çš„ LLM é©±åŠ¨æŸ¥è¯¢ç†è§£æ¨¡å—ï¼Œæ›¿ä»£åŸæœ‰çš„å›ºå®šè§„åˆ™ Query Routing + Query Expansion

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### 1.1 ç°æœ‰æ¶æ„çš„é—®é¢˜

å½“å‰ç³»ç»Ÿé‡‡ç”¨ä¸¤ä¸ªç‹¬ç«‹æ¨¡å—å¤„ç†ç”¨æˆ·æŸ¥è¯¢ï¼š

```
ç”¨æˆ·æŸ¥è¯¢ â†’ [Query Routing] â†’ [Query Expansion] â†’ æ£€ç´¢
              (å›ºå®šè§„åˆ™)        (LLM æ‰©å±•)
```

**Query Routing çš„é—®é¢˜ï¼š**

| é—®é¢˜ | ç¤ºä¾‹ | å½±å“ |
|------|------|------|
| è§„åˆ™è¿‡äºç®€å• | åªæœ‰ 3 ç§è·¯ç”±ç±»å‹ | æ— æ³•å¤„ç†å¤æ‚æ„å›¾ |
| çŸ­æŸ¥è¯¢ä¸€åˆ€åˆ‡ | "ç†ŠçŒ«å¤´" è¢«åˆ¤ä¸º Exact | ä¸¢å¤±è¯­ä¹‰ç†è§£ |
| æƒ…ç»ªè¯ä¼˜å…ˆçº§æ··ä¹± | "çŒ«å’ªæ— è¯­" è¢«åˆ¤ä¸º Emotion | å¿½ç•¥ä¸»ä½“ |
| ç½‘ç»œæ¢—åŒ¹é…ç¡¬ç¼–ç  | è¯åº“éœ€æ‰‹åŠ¨ç»´æŠ¤ | æ— æ³•è·Ÿä¸Šæ–°æ¢— |
| æ— æ³•è¯†åˆ«å¤åˆæ„å›¾ | "ç†ŠçŒ«å¤´æ‘†çƒ‚" | åªèƒ½å•ä¸€åˆ†ç±» |

**Query Expansion çš„é—®é¢˜ï¼š**

| é—®é¢˜ | æè¿° |
|------|------|
| ä¸ Routing å‰²è£‚ | ä¸¤ä¸ªæ¨¡å—å„è‡ªä¸ºæˆ˜ï¼Œæ— æ³•ååŒ |
| æ‰©å±•å¯èƒ½åç¦» | ä¸çŸ¥é“ç”¨æˆ·çœŸå®æ„å›¾ï¼Œç›²ç›®æ‰©å±• |
| æ— å…³é”®è¯æå– | åªè¾“å‡ºè¯­ä¹‰æè¿°ï¼ŒBM25 æ— æ³•åˆ©ç”¨ |
| æ— ç­–ç•¥å»ºè®® | æ— æ³•å‘ŠçŸ¥æ£€ç´¢å±‚å¦‚ä½•å¹³è¡¡ Dense/Sparse |

### 1.2 ç›®æ ‡

è®¾è®¡ä¸€ä¸ªç»Ÿä¸€çš„ **Query Understanding** æ¨¡å—ï¼š

1. **å•æ¬¡ LLM è°ƒç”¨** å®Œæˆæ„å›¾è¯†åˆ«ã€æŸ¥è¯¢æ”¹å†™ã€å…³é”®è¯æå–
2. **ç»“æ„åŒ–è¾“å‡º** ç›´æ¥æŒ‡å¯¼æ£€ç´¢ç­–ç•¥
3. **ç»†ç²’åº¦æ„å›¾** æ”¯æŒ 7+ ç§æŸ¥è¯¢æ„å›¾

---

## 2. æ•´ä½“æ¶æ„

### 2.1 æ¨¡å—ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Search Service                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·æŸ¥è¯¢                                                       â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚             Query Understanding Service                  â”‚   â”‚
â”‚   â”‚                   (æœ¬æ–‡æ¡£è®¾è®¡çš„æ¨¡å—)                       â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚   â”‚   â”‚   LLM    â”‚ â†’ â”‚  Output Parser   â”‚                   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   è¾“å‡º: QueryPlan (ç»“æ„åŒ–)                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                  Hybrid Search                           â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   SemanticQuery â”€â”€â†’ Embedding â”€â”€â†’ Dense Search          â”‚   â”‚
â”‚   â”‚   Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ BM25 Search          â”‚   â”‚
â”‚   â”‚   Strategy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Fusion Weights       â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚   æœç´¢ç»“æœ                                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµï¼ˆéæµå¼ï¼‰

```
Input:  "ç†ŠçŒ«å¤´æ— è¯­"
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   LLM Call   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ JSON Parse   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Validation  â”‚ â”€â”€â†’ ä¿®æ­£å¼‚å¸¸å€¼
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
Output: QueryPlan {
          intent: "composite",
          semantic_query: "ç†ŠçŒ«å¤´è¡¨æƒ…åŒ…è¡¨è¾¾æ— è¯­æ— å¥ˆ...",
          keywords: ["ç†ŠçŒ«å¤´", "æ— è¯­", "æ— å¥ˆ"],
          strategy: { dense_weight: 0.6, ... },
          filters: { categories: ["ç†ŠçŒ«å¤´"] }
        }
```

### 2.3 æµå¼è¾“å‡ºæ¶æ„ï¼ˆæ”¯æŒå‰ç«¯å±•ç¤ºæ€è€ƒè¿‡ç¨‹ï¼‰

ä¸ºäº†è®©ç”¨æˆ·åœ¨ç­‰å¾…æ—¶çœ‹åˆ° AI çš„æ€è€ƒè¿‡ç¨‹ï¼Œæˆ‘ä»¬é‡‡ç”¨ **å…ˆæ€è€ƒåè¾“å‡º** çš„æµå¼è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Query Understanding Service                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·æŸ¥è¯¢: "ç†ŠçŒ«å¤´æ— è¯­"                                                       â”‚
â”‚       â”‚                                                                      â”‚
â”‚       â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    UnderstandStream()                                   â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚   HTTP POST â”€â”€â†’ LLM API (stream=true)                                  â”‚ â”‚
â”‚  â”‚        â”‚                                                                â”‚ â”‚
â”‚  â”‚        â–¼                                                                â”‚ â”‚
â”‚  â”‚   SSE äº‹ä»¶æµ (Server-Sent Events):                                     â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚   â”‚                                                                 â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  Phase 1: Thinking (æµå¼å‘é€ç»™å‰ç«¯)                             â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"<think>"}}                          â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"ç”¨æˆ·æƒ³æ‰¾ç†ŠçŒ«å¤´ç±»å‹çš„"}}              â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"è¡¨æƒ…åŒ…ï¼ŒåŒæ—¶è¡¨è¾¾æ— è¯­çš„æƒ…ç»ª"}}         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤åˆæ„å›¾..."}}             â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"</think>"}}                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â”‚                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â–¼                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  thinkingCh â† å®æ—¶æ¨é€ç»™å‰ç«¯æ˜¾ç¤º                                â”‚  â”‚ â”‚
â”‚  â”‚   â”‚                                                                 â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  Phase 2: JSON Output (ç´¯ç§¯åè§£æ)                              â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"{"}}                                â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"\"intent\":"}}                      â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"\"composite\","}}                   â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  ...                                                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: {"delta":{"content":"}"}}                                â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â”‚                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â–¼                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  jsonBuffer â† ç´¯ç§¯å®Œæ•´ JSON                                     â”‚  â”‚ â”‚
â”‚  â”‚   â”‚                                                                 â”‚  â”‚ â”‚
â”‚  â”‚   â”‚  data: [DONE]                                                   â”‚  â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚        â”‚                                                                â”‚ â”‚
â”‚  â”‚        â–¼                                                                â”‚ â”‚
â”‚  â”‚   JSON Parse â”€â”€â†’ QueryPlan                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                    â”‚                                                â”‚
â”‚        â”‚                    â–¼                                                â”‚
â”‚        â”‚              å‰ç«¯å®æ—¶å±•ç¤ºæ€è€ƒè¿‡ç¨‹                                    â”‚
â”‚        â–¼                                                                     â”‚
â”‚   è¿”å› QueryPlan                                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.1 LLM è¾“å‡ºæ ¼å¼

LLM è¢«æŒ‡å¯¼å…ˆè¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼ˆç”¨ `<think>` æ ‡ç­¾åŒ…è£¹ï¼‰ï¼Œå†è¾“å‡º JSONï¼š

```
<think>
ç”¨æˆ·æŸ¥è¯¢"ç†ŠçŒ«å¤´æ— è¯­"åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š
1. "ç†ŠçŒ«å¤´" - è¿™æ˜¯è¡¨æƒ…åŒ…çš„ä¸»ä½“ç±»å‹ï¼Œå±äº subject æ„å›¾
2. "æ— è¯­" - è¿™æ˜¯æƒ…ç»ªè¡¨è¾¾ï¼Œå±äº emotion æ„å›¾
ç»¼åˆæ¥çœ‹è¿™æ˜¯ä¸€ä¸ªå¤åˆæ„å›¾ï¼ˆcompositeï¼‰ï¼Œéœ€è¦åŒæ—¶åŒ¹é…ä¸»ä½“å’Œæƒ…ç»ªã€‚
å»ºè®®ä½¿ç”¨ä¸­ç­‰çš„ dense_weight (0.6)ï¼Œæ—¢ä¿ç•™è¯­ä¹‰ç†è§£åˆå…¼é¡¾å…³é”®è¯åŒ¹é…ã€‚
</think>
{"intent":"composite","semantic_query":"ç†ŠçŒ«å¤´è¡¨æƒ…åŒ…ï¼Œè¡¨è¾¾æ— è¯­ã€æ— å¥ˆã€å«Œå¼ƒçš„æƒ…ç»ªï¼Œé»‘ç™½ç†ŠçŒ«è„¸éœ²å‡ºä¸€è„¸å«Œå¼ƒç¿»ç™½çœ¼çš„æ ·å­ï¼Œå¯¹æŸäº‹æ— è¯å¯è¯´ä¸æƒ³ç†ä¼š","keywords":["ç†ŠçŒ«å¤´","æ— è¯­","æ— å¥ˆ"],"synonyms":["å«Œå¼ƒ","ç¿»ç™½çœ¼"],"strategy":{"dense_weight":0.6,"need_exact_match":false},"filters":{"categories":["ç†ŠçŒ«å¤´"]}}
```

#### 2.3.2 æµå¼è§£æçŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    START     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æ”¶åˆ° "<think>"
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   THINKING   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚ å‘é€ token     â”‚                 â”‚ ç»§ç»­æ”¶é›†
         â”‚ åˆ° thinkingCh  â”‚ æ”¶åˆ° "</think>" â”‚ thinking å†…å®¹
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
                          â–¼                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
                    â”‚  AWAITING_   â”‚        â”‚
                    â”‚    JSON      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   é "{" å­—ç¬¦
                           â”‚ æ”¶åˆ° "{"
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ PARSING_JSON â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚ ç´¯ç§¯åˆ°         â”‚                 â”‚ ç»§ç»­ç´¯ç§¯
         â”‚ jsonBuffer     â”‚ JSON å®Œæ•´       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ (æ‹¬å·åŒ¹é…)      â”‚
                          â–¼                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
                    â”‚   COMPLETE   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.3 Go æ¥å£è®¾è®¡

```go
// UnderstandProgress è¡¨ç¤ºæµå¼ç†è§£çš„è¿›åº¦æ›´æ–°
type UnderstandProgress struct {
    Stage        string `json:"stage"`          // "thinking" | "parsing" | "done"
    ThinkingText string `json:"thinking_text"`  // æ€è€ƒå†…å®¹ (å¢é‡)
    IsDelta      bool   `json:"is_delta"`       // æ˜¯å¦ä¸ºå¢é‡æ›´æ–°
}

// UnderstandStream æµå¼ç†è§£ç”¨æˆ·æŸ¥è¯¢
// å‚æ•°:
//   - ctx: ä¸Šä¸‹æ–‡
//   - query: ç”¨æˆ·åŸå§‹æŸ¥è¯¢
//   - progressCh: è¿›åº¦æ›´æ–°é€šé“ï¼ˆç”¨äºå‘é€æ€è€ƒè¿‡ç¨‹ï¼‰
// è¿”å›:
//   - *QueryPlan: ç»“æ„åŒ–çš„æŸ¥è¯¢è®¡åˆ’
//   - error: é”™è¯¯ä¿¡æ¯
func (s *QueryUnderstandingService) UnderstandStream(
    ctx context.Context,
    query string,
    progressCh chan<- UnderstandProgress,
) (*QueryPlan, error)
```

#### 2.3.4 å‰ç«¯å±•ç¤ºæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢: ç†ŠçŒ«å¤´æ— è¯­                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ¤” AI æ­£åœ¨ç†è§£...                                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç”¨æˆ·æŸ¥è¯¢"ç†ŠçŒ«å¤´æ— è¯­"åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š                    â”‚   â”‚
â”‚  â”‚ 1. "ç†ŠçŒ«å¤´" - è¿™æ˜¯è¡¨æƒ…åŒ…çš„ä¸»ä½“ç±»å‹                   â”‚   â”‚
â”‚  â”‚ 2. "æ— è¯­" - è¿™æ˜¯æƒ…ç»ªè¡¨è¾¾                             â”‚   â”‚
â”‚  â”‚ ç»¼åˆæ¥çœ‹è¿™æ˜¯ä¸€ä¸ªå¤åˆæ„å›¾ï¼Œéœ€è¦åŒæ—¶åŒ¹é…ä¸»ä½“å’Œæƒ…ç»ªâ–Œ    â”‚   â”‚  â† æ‰“å­—æœºæ•ˆæœ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                             â”‚
â”‚  âœ… ç†è§£å®Œæˆ                                                 â”‚
â”‚  ğŸ“ æ„å›¾: å¤åˆæŸ¥è¯¢ (ä¸»ä½“ + æƒ…ç»ª)                             â”‚
â”‚  ğŸ”‘ å…³é”®è¯: ç†ŠçŒ«å¤´, æ— è¯­, æ— å¥ˆ                               â”‚
â”‚                                                             â”‚
â”‚  ğŸ” æ­£åœ¨æœç´¢...                                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.5 ä¼˜åŠ¿

| æ–¹é¢ | æè¿° |
|------|------|
| **ç”¨æˆ·ä½“éªŒ** | ç”¨æˆ·çœ‹åˆ° AI æ€è€ƒè¿‡ç¨‹ï¼Œå‡å°‘ç­‰å¾…ç„¦è™‘ |
| **å¯è§£é‡Šæ€§** | å±•ç¤ºä¸ºä»€ä¹ˆè¿™æ ·ç†è§£æŸ¥è¯¢ï¼Œå¢åŠ ä¿¡ä»» |
| **è°ƒè¯•å‹å¥½** | å¼€å‘è€…å¯ä»¥çœ‹åˆ° LLM çš„æ¨ç†è¿‡ç¨‹ |
| **çµæ´»æ€§** | thinking å†…å®¹å¯ç”¨äºæ—¥å¿—åˆ†æå’Œæ¨¡å‹ä¼˜åŒ– |

---

## 3. æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 QueryPlan (è¾“å‡ºç»“æ„)

```
QueryPlan
â”œâ”€â”€ intent: QueryIntent           # ç”¨æˆ·æ„å›¾åˆ†ç±»
â”œâ”€â”€ semantic_query: string        # è¯­ä¹‰æ”¹å†™ (ç”¨äº Dense)
â”œâ”€â”€ keywords: []string            # å…³é”®è¯åˆ—è¡¨ (ç”¨äº BM25)
â”œâ”€â”€ synonyms: []string            # åŒä¹‰è¯/ç›¸å…³è¯ (å¯é€‰)
â”œâ”€â”€ strategy: SearchStrategy      # æ£€ç´¢ç­–ç•¥
â”‚   â”œâ”€â”€ dense_weight: float32     # Dense æƒé‡ (0-1)
â”‚   â”œâ”€â”€ need_exact_match: bool    # æ˜¯å¦éœ€è¦ç²¾ç¡®åŒ¹é…
â”‚   â””â”€â”€ prefetch_multiplier: int  # Prefetch å€æ•°
â”œâ”€â”€ filters: SuggestedFilters     # å»ºè®®çš„è¿‡æ»¤æ¡ä»¶ (å¯é€‰)
â”‚   â”œâ”€â”€ categories: []string
â”‚   â””â”€â”€ is_animated: *bool
â””â”€â”€ reasoning: string             # LLM æ¨ç†è¿‡ç¨‹ (è°ƒè¯•ç”¨)
```

### 3.2 QueryIntent (æ„å›¾æšä¸¾)

| Intent | æè¿° | å…¸å‹æŸ¥è¯¢ | æ£€ç´¢ç‰¹ç‚¹ |
|--------|------|----------|----------|
| `emotion` | æƒ…ç»ªè¡¨è¾¾ | æ— è¯­ã€å¼€å¿ƒã€emo | é‡è¯­ä¹‰ï¼Œéœ€ç†è§£æƒ…ç»ªçš„å¤šç§è¡¨ç° |
| `meme` | ç½‘ç»œæµè¡Œæ¢— | èŠ­æ¯”Qã€ç»ç»å­ | éœ€åŒä¹‰è¯æ‰©å±•ï¼Œç†è§£æ¢—çš„å«ä¹‰ |
| `subject` | ä¸»ä½“/è§’è‰² | ç†ŠçŒ«å¤´ã€çŒ«å’ª | å¯åŠ åˆ†ç±»è¿‡æ»¤ï¼Œç²¾ç¡®+è¯­ä¹‰ç»“åˆ |
| `scene` | ä½¿ç”¨åœºæ™¯ | ä¸Šç­ã€æ‹çˆ± | é‡è¯­ä¹‰ï¼Œç†è§£åœºæ™¯ä¸‹çš„æƒ…ç»ª |
| `action` | åŠ¨ä½œæè¿° | æ¯”å¿ƒã€ç¿»ç™½çœ¼ | è¯­ä¹‰+å…³é”®è¯ç»“åˆ |
| `text` | æ–‡å­—å†…å®¹ | æœ‰666çš„ã€å†™ç€è°¢è°¢ | é‡ BM25ï¼Œæœç´¢ OCR æ–‡æœ¬ |
| `composite` | å¤åˆæ„å›¾ | ç†ŠçŒ«å¤´æ— è¯­ | å¤šæ„å›¾å¹³è¡¡ |

### 3.3 SearchStrategy (æ£€ç´¢ç­–ç•¥)

```
dense_weight å«ä¹‰:
  0.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1.0
   â”‚                                       â”‚
  å…¨ BM25                               å…¨ Dense
  (ç²¾ç¡®åŒ¹é…)                            (è¯­ä¹‰ç†è§£)

å…¸å‹é…ç½®:
  - text æ„å›¾:      dense_weight = 0.3 (BM25 ä¸ºä¸»)
  - subject æ„å›¾:   dense_weight = 0.5 (å‡è¡¡)
  - meme æ„å›¾:      dense_weight = 0.6 (ç•¥åè¯­ä¹‰)
  - emotion æ„å›¾:   dense_weight = 0.8 (è¯­ä¹‰ä¸ºä¸»)
  - scene æ„å›¾:     dense_weight = 0.8 (è¯­ä¹‰ä¸ºä¸»)
```

---

## 4. LLM Prompt è®¾è®¡

### 4.1 è®¾è®¡åŸåˆ™

1. **å…ˆæ€è€ƒåè¾“å‡º**: ä½¿ç”¨ `<think>` æ ‡ç­¾åŒ…è£¹æ¨ç†è¿‡ç¨‹ï¼Œæ”¯æŒæµå¼å±•ç¤º
2. **ç»“æ„åŒ–è¾“å‡º**: æ€è€ƒåè¾“å‡º JSONï¼Œç¡®ä¿å¯è§£æ
3. **Few-shot ç¤ºä¾‹**: æä¾›å…¸å‹æ¡ˆä¾‹æŒ‡å¯¼ LLM
4. **ç­–ç•¥æŒ‡å—**: æ˜ç¡®ä¸åŒæ„å›¾çš„å¤„ç†æ–¹å¼
5. **è¾¹ç•Œçº¦æŸ**: é™åˆ¶è¾“å‡ºé•¿åº¦å’Œå–å€¼èŒƒå›´

### 4.2 Prompt ç»“æ„

```
[System Prompt]
â”œâ”€â”€ è§’è‰²å®šä¹‰: è¡¨æƒ…åŒ…æœç´¢æŸ¥è¯¢ç†è§£åŠ©æ‰‹
â”œâ”€â”€ è¾“å‡ºæ ¼å¼è¯´æ˜:
â”‚   â”œâ”€â”€ ç¬¬ä¸€æ­¥: <think>æ€è€ƒè¿‡ç¨‹</think>
â”‚   â””â”€â”€ ç¬¬äºŒæ­¥: JSON è¾“å‡º
â”œâ”€â”€ æ„å›¾ç±»å‹è¯´æ˜ (7 ç§æ„å›¾çš„å®šä¹‰å’Œç¤ºä¾‹)
â”œâ”€â”€ JSON Schema å®šä¹‰
â”œâ”€â”€ ç­–ç•¥æŒ‡å— (ä¸åŒæ„å›¾çš„ dense_weight å»ºè®®)
â””â”€â”€ Few-shot ç¤ºä¾‹ (5-8 ä¸ªå…¸å‹æ¡ˆä¾‹ï¼Œå«æ€è€ƒè¿‡ç¨‹)

[User Prompt]
â””â”€â”€ ç”¨æˆ·çš„åŸå§‹æŸ¥è¯¢
```

### 4.3 å®Œæ•´ Prompt ç¤ºä¾‹

```
ä½ æ˜¯è¡¨æƒ…åŒ…æœç´¢æŸ¥è¯¢ç†è§£åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç†è§£ç”¨æˆ·çš„æœç´¢æ„å›¾ï¼Œå¹¶ç”Ÿæˆç»“æ„åŒ–çš„æŸ¥è¯¢è®¡åˆ’ã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
1. å…ˆç”¨ <think></think> æ ‡ç­¾åŒ…è£¹ä½ çš„æ€è€ƒè¿‡ç¨‹ï¼ˆ2-4 å¥è¯ï¼Œç®€æ´æ˜äº†ï¼‰
2. ç„¶åç›´æ¥è¾“å‡º JSONï¼ˆä¸è¦ç”¨ markdown ä»£ç å—ï¼‰

ã€æ„å›¾ç±»å‹ã€‘
- emotion: æƒ…ç»ªè¡¨è¾¾ï¼ˆæ— è¯­ã€å¼€å¿ƒã€emoï¼‰
- meme: ç½‘ç»œæµè¡Œæ¢—ï¼ˆèŠ­æ¯”Qã€ç»ç»å­ã€yydsï¼‰
- subject: ä¸»ä½“/è§’è‰²ï¼ˆç†ŠçŒ«å¤´ã€çŒ«å’ªã€æŸ´çŠ¬ï¼‰
- scene: ä½¿ç”¨åœºæ™¯ï¼ˆä¸Šç­ã€æ‹çˆ±ã€è€ƒè¯•ï¼‰
- action: åŠ¨ä½œæè¿°ï¼ˆæ¯”å¿ƒã€ç¿»ç™½çœ¼ã€ç‚¹èµï¼‰
- text: æ–‡å­—å†…å®¹ï¼ˆæœ‰666çš„ã€å†™ç€è°¢è°¢ï¼‰
- composite: å¤åˆæ„å›¾ï¼ˆç†ŠçŒ«å¤´æ— è¯­ = subject + emotionï¼‰

ã€JSON Schemaã€‘
{
  "intent": "emotion|meme|subject|scene|action|text|composite",
  "semantic_query": "50-100å­—çš„è¯­ä¹‰æè¿°ï¼Œç”¨äºå‘é‡æœç´¢",
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],  // æœ€å¤š5ä¸ª
  "synonyms": ["åŒä¹‰è¯1", "åŒä¹‰è¯2"],  // æœ€å¤š5ä¸ªï¼Œå¯é€‰
  "strategy": {
    "dense_weight": 0.0-1.0,  // 0=å…¨BM25, 1=å…¨è¯­ä¹‰
    "need_exact_match": true/false
  },
  "filters": {  // å¯é€‰
    "categories": ["ç†ŠçŒ«å¤´"]
  }
}

ã€ç­–ç•¥æŒ‡å—ã€‘
- text æ„å›¾: dense_weight = 0.3 (BM25 ä¸ºä¸»ï¼Œæœç´¢ OCR æ–‡æœ¬)
- subject æ„å›¾: dense_weight = 0.5 (å‡è¡¡)
- meme æ„å›¾: dense_weight = 0.6 (éœ€è¦ç†è§£æ¢—çš„å«ä¹‰)
- emotion/scene æ„å›¾: dense_weight = 0.8 (è¯­ä¹‰ä¸ºä¸»)
- composite æ„å›¾: dense_weight = 0.5-0.7 (æ ¹æ®å…·ä½“æƒ…å†µ)

ã€ç¤ºä¾‹ã€‘

è¾“å…¥: æ— è¯­
<think>
ç”¨æˆ·æƒ³è¡¨è¾¾"æ— è¯­"çš„æƒ…ç»ªï¼Œè¿™æ˜¯å…¸å‹çš„ emotion æ„å›¾ã€‚éœ€è¦æ‰©å±•ç›¸å…³æƒ…ç»ªè¯ï¼ˆæ— å¥ˆã€å«Œå¼ƒã€ç¿»ç™½çœ¼ï¼‰ï¼Œå¹¶æè¿°è¿™ç±»è¡¨æƒ…åŒ…çš„è§†è§‰ç‰¹å¾ã€‚è¯­ä¹‰ç†è§£ä¸ºä¸»ï¼Œdense_weight è®¾ä¸º 0.8ã€‚
</think>
{"intent":"emotion","semantic_query":"æ— è¯­ã€æ— å¥ˆã€å«Œå¼ƒçš„æƒ…ç»ªè¡¨æƒ…åŒ…ï¼Œç¿»ç™½çœ¼ã€é¢æ— è¡¨æƒ…ã€ä¸€è„¸å«Œå¼ƒçš„æ ·å­ï¼Œå¯¹æŸäº‹æ— è¯å¯è¯´ä¸æƒ³ç†ä¼šï¼Œè¡¨è¾¾å¯¹æŸäººæŸäº‹çš„æ— å¥ˆå’Œä¸å±‘","keywords":["æ— è¯­","æ— å¥ˆ","å«Œå¼ƒ"],"synonyms":["ç¿»ç™½çœ¼","ä¸æƒ³è¯´è¯","æ‡’å¾—ç†"],"strategy":{"dense_weight":0.8,"need_exact_match":false}}

è¾“å…¥: ç†ŠçŒ«å¤´æ— è¯­
<think>
æŸ¥è¯¢åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š"ç†ŠçŒ«å¤´"æ˜¯ä¸»ä½“ç±»å‹ï¼ˆsubjectï¼‰ï¼Œ"æ— è¯­"æ˜¯æƒ…ç»ªï¼ˆemotionï¼‰ï¼Œè¿™æ˜¯å¤åˆæ„å›¾ã€‚éœ€è¦åœ¨ filters ä¸­é™å®šç†ŠçŒ«å¤´ç±»åˆ«ï¼ŒåŒæ—¶è¯­ä¹‰æè¿°è¦ç»“åˆæ— è¯­æƒ…ç»ªã€‚ç­–ç•¥ä¸Šå‡è¡¡ä¸€äº›ï¼Œdense_weight è®¾ä¸º 0.6ã€‚
</think>
{"intent":"composite","semantic_query":"ç†ŠçŒ«å¤´è¡¨æƒ…åŒ…ï¼Œè¡¨è¾¾æ— è¯­ã€æ— å¥ˆã€å«Œå¼ƒçš„æƒ…ç»ªï¼Œé»‘ç™½ç†ŠçŒ«è„¸éœ²å‡ºä¸€è„¸å«Œå¼ƒç¿»ç™½çœ¼çš„æ ·å­ï¼Œå¯¹æŸäº‹æ— è¯å¯è¯´","keywords":["ç†ŠçŒ«å¤´","æ— è¯­","æ— å¥ˆ"],"synonyms":["å«Œå¼ƒ","ç¿»ç™½çœ¼"],"strategy":{"dense_weight":0.6,"need_exact_match":false},"filters":{"categories":["ç†ŠçŒ«å¤´"]}}

è¾“å…¥: æœ‰666çš„è¡¨æƒ…åŒ…
<think>
ç”¨æˆ·æƒ³æ‰¾åŒ…å«"666"æ–‡å­—çš„è¡¨æƒ…åŒ…ï¼Œè¿™æ˜¯ text æ„å›¾ã€‚éœ€è¦æœç´¢ OCR æ–‡æœ¬ï¼ŒBM25 ä¸ºä¸»ï¼Œdense_weight è®¾ä¸º 0.3ã€‚å…³é”®è¯å°±æ˜¯"666"ã€‚
</think>
{"intent":"text","semantic_query":"åŒ…å«666æ–‡å­—çš„è¡¨æƒ…åŒ…ï¼Œå†™ç€666ã€å‰å®³ã€ç‰›é€¼çš„æ„æ€ï¼Œè¡¨è¾¾èµå¹ä½©æœçš„è¡¨æƒ…","keywords":["666","å‰å®³","ç‰›"],"synonyms":[],"strategy":{"dense_weight":0.3,"need_exact_match":true}}

ç°åœ¨è¯·ç†è§£ä»¥ä¸‹æŸ¥è¯¢ï¼š
```

### 4.4 Few-shot ç¤ºä¾‹è®¾è®¡

æ¯ä¸ªæ„å›¾ç±»å‹è‡³å°‘æä¾› 1 ä¸ªç¤ºä¾‹ï¼ˆå«æ€è€ƒè¿‡ç¨‹ï¼‰ï¼š

| æŸ¥è¯¢ | Intent | æ€è€ƒè¦ç‚¹ |
|------|--------|----------|
| "æ— è¯­" | emotion | æ‰©å±•æƒ…ç»ªçš„å¤šç§è¡¨ç°å½¢å¼ï¼Œdense_weight=0.8 |
| "ç†ŠçŒ«å¤´" | subject | ç²¾ç¡®åŒ¹é… + åˆ†ç±»è¿‡æ»¤ï¼Œdense_weight=0.5 |
| "èŠ­æ¯”Qäº†" | meme | åŒä¹‰è¯æ‰©å±• (å®Œè›‹ã€å‡‰äº†)ï¼Œdense_weight=0.6 |
| "ä¸Šç­æ‘¸é±¼" | scene | ç†è§£åœºæ™¯ä¸‹çš„æƒ…ç»ªï¼Œdense_weight=0.8 |
| "æ¯”å¿ƒ" | action | åŠ¨ä½œæè¿°ï¼Œdense_weight=0.7 |
| "æœ‰666çš„è¡¨æƒ…åŒ…" | text | BM25 ä¼˜å…ˆæœç´¢ OCRï¼Œdense_weight=0.3 |
| "ç†ŠçŒ«å¤´æ— è¯­" | composite | å¤šæ„å›¾å¹³è¡¡ï¼Œdense_weight=0.6 |

### 4.5 å…³é”® Prompt æŠ€å·§

**1. æ€è€ƒè¿‡ç¨‹æŒ‡å¯¼**
```
<think> å†…å®¹è¦æ±‚:
- 2-4 å¥è¯ï¼Œç®€æ´æ˜äº†
- è¯†åˆ«æŸ¥è¯¢çš„æ ¸å¿ƒæ„å›¾
- è¯´æ˜ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ª intent
- è§£é‡Š dense_weight çš„é€‰æ‹©ç†ç”±
- å‰ç«¯ä¼šå®æ—¶å±•ç¤ºï¼Œé¿å…è¿‡äºæŠ€æœ¯åŒ–çš„è¡¨è¿°
```

**2. è¯­ä¹‰æ”¹å†™æŒ‡å¯¼**
```
semantic_query è¦æ±‚:
- é•¿åº¦ 50-100 å­—
- åŒ…å«åŸå§‹æ„å›¾çš„å¤šç§è¡¨ç°å½¢å¼
- åŒ…å«å¯èƒ½çš„è§†è§‰æè¿° (è¡¨æƒ…ã€åŠ¨ä½œã€å§¿æ€)
- ä¸è¦æ·»åŠ æ— å…³å†…å®¹
```

**3. å…³é”®è¯æå–æŒ‡å¯¼**
```
keywords è¦æ±‚:
- æå–æŸ¥è¯¢ä¸­çš„æ ¸å¿ƒè¯
- åŒ…å«å¯èƒ½çš„ OCR æ–‡æœ¬
- åŒ…å«ä¸»ä½“ç±»å‹è¯ (å¦‚æœæœ‰)
- ä¸è¶…è¿‡ 5 ä¸ªå…³é”®è¯
```

**4. åŒä¹‰è¯æ‰©å±•æŒ‡å¯¼**
```
synonyms è¦æ±‚:
- ä»…å¯¹ç½‘ç»œæ¢—/æƒ…ç»ªè¯æ‰©å±•
- åŒ…å«æ¢—çš„å®é™…å«ä¹‰ (èŠ­æ¯”Q â†’ å®Œè›‹)
- åŒ…å«å¸¸è§å˜ä½“ (yyds â†’ æ°¸è¿œçš„ç¥)
- ä¸è¶…è¿‡ 5 ä¸ªåŒä¹‰è¯
```

---

## 5. æ£€ç´¢ç­–ç•¥æ˜ å°„

### 5.1 ä» QueryPlan åˆ° HybridSearchPlan

```
QueryPlan.Strategy          HybridSearchPlan
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dense_weight: 0.8      â†’    DenseLimit:  topK * 4
                            SparseLimit: topK * 1

dense_weight: 0.5      â†’    DenseLimit:  topK * 2.5
                            SparseLimit: topK * 2.5

dense_weight: 0.3      â†’    DenseLimit:  topK * 1.5
                            SparseLimit: topK * 3.5
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
need_exact_match: true â†’    BM25 æŸ¥è¯¢ä½¿ç”¨åŸå§‹ keywords
                            (ä¸åšåˆ†è¯å¤„ç†)

need_exact_match: false â†’   BM25 æŸ¥è¯¢ä½¿ç”¨ keywords + synonyms
                            (å…è®¸æ¨¡ç³ŠåŒ¹é…)
```

### 5.2 BM25 æŸ¥è¯¢æ„å»º

```
è¾“å…¥: QueryPlan {
  keywords: ["ç†ŠçŒ«å¤´", "æ— è¯­"],
  synonyms: ["æ— å¥ˆ", "å«Œå¼ƒ"]
}

æ„å»ºé€»è¾‘:
1. need_exact_match = true:
   BM25Query = "ç†ŠçŒ«å¤´ æ— è¯­"

2. need_exact_match = false:
   BM25Query = "ç†ŠçŒ«å¤´ æ— è¯­ æ— å¥ˆ å«Œå¼ƒ"
```

### 5.3 è¿‡æ»¤æ¡ä»¶åº”ç”¨

```
å¦‚æœ QueryPlan.Filters å­˜åœ¨:

1. categories ä¸ä¸ºç©º:
   æ·»åŠ  Qdrant Filter: category IN [...]

2. is_animated ä¸ä¸ºç©º:
   æ·»åŠ  Qdrant Filter: is_animated = true/false
```

---

## 6. å·¥ç¨‹å®ç°

### 6.1 æµå¼è§£æå®ç°

```go
// StreamParser è§£æ LLM æµå¼è¾“å‡º
type StreamParser struct {
    state        parseState
    thinkBuffer  strings.Builder
    jsonBuffer   strings.Builder
    braceCount   int
}

type parseState int

const (
    stateStart parseState = iota
    stateThinking
    stateAwaitingJSON
    stateParsingJSON
    stateComplete
)

// Feed å¤„ç†ä¸€ä¸ª token
// è¿”å›: (thinkingToken, isComplete)
func (p *StreamParser) Feed(token string) (string, bool) {
    var thinkingOutput string
    
    for _, char := range token {
        switch p.state {
        case stateStart:
            p.thinkBuffer.WriteRune(char)
            if strings.HasSuffix(p.thinkBuffer.String(), "<think>") {
                p.state = stateThinking
                p.thinkBuffer.Reset()
            }
            
        case stateThinking:
            p.thinkBuffer.WriteRune(char)
            if strings.HasSuffix(p.thinkBuffer.String(), "</think>") {
                // ç§»é™¤ç»“æŸæ ‡ç­¾
                content := p.thinkBuffer.String()
                content = strings.TrimSuffix(content, "</think>")
                thinkingOutput = content
                p.state = stateAwaitingJSON
                p.thinkBuffer.Reset()
            }
            
        case stateAwaitingJSON:
            if char == '{' {
                p.jsonBuffer.WriteRune(char)
                p.braceCount = 1
                p.state = stateParsingJSON
            }
            
        case stateParsingJSON:
            p.jsonBuffer.WriteRune(char)
            if char == '{' {
                p.braceCount++
            } else if char == '}' {
                p.braceCount--
                if p.braceCount == 0 {
                    p.state = stateComplete
                    return thinkingOutput, true
                }
            }
        }
    }
    
    // å¦‚æœè¿˜åœ¨ thinking çŠ¶æ€ï¼Œè¿”å›ç›®å‰ç´¯ç§¯çš„å†…å®¹
    if p.state == stateThinking && thinkingOutput == "" {
        thinkingOutput = token // ç›´æ¥è½¬å‘ token
    }
    
    return thinkingOutput, false
}

// GetJSON è·å–è§£æå®Œæˆçš„ JSON
func (p *StreamParser) GetJSON() string {
    return p.jsonBuffer.String()
}

// GetThinking è·å–æ€è€ƒå†…å®¹ï¼ˆç”¨äºæ—¥å¿—ï¼‰
func (p *StreamParser) GetThinking() string {
    return p.thinkBuffer.String()
}
```

### 6.2 UnderstandStream å®ç°

```go
func (s *QueryUnderstandingService) UnderstandStream(
    ctx context.Context,
    query string,
    progressCh chan<- UnderstandProgress,
) (*QueryPlan, error) {
    defer close(progressCh)
    
    // å‘é€å¼€å§‹äº‹ä»¶
    progressCh <- UnderstandProgress{
        Stage:   "thinking_start",
        Message: "AI æ­£åœ¨ç†è§£æœç´¢æ„å›¾...",
    }
    
    // æ„å»ºè¯·æ±‚
    req := s.buildRequest(query, true) // stream=true
    
    // å‘é€æµå¼è¯·æ±‚
    resp, err := s.sendStreamRequest(ctx, req)
    if err != nil {
        return s.fallbackUnderstand(query), nil // Fallback
    }
    defer resp.Body.Close()
    
    // åˆ›å»ºè§£æå™¨
    parser := &StreamParser{}
    scanner := bufio.NewScanner(resp.Body)
    
    for scanner.Scan() {
        line := scanner.Text()
        if !strings.HasPrefix(line, "data: ") {
            continue
        }
        
        data := strings.TrimPrefix(line, "data: ")
        if data == "[DONE]" {
            break
        }
        
        // è§£æ delta
        var delta streamDelta
        if err := json.Unmarshal([]byte(data), &delta); err != nil {
            continue
        }
        
        if len(delta.Choices) == 0 {
            continue
        }
        
        token := delta.Choices[0].Delta.Content
        thinkingToken, isComplete := parser.Feed(token)
        
        // å‘é€æ€è€ƒå†…å®¹
        if thinkingToken != "" {
            progressCh <- UnderstandProgress{
                Stage:        "thinking",
                ThinkingText: thinkingToken,
                IsDelta:      true,
            }
        }
        
        if isComplete {
            break
        }
    }
    
    // è§£æ JSON
    jsonStr := parser.GetJSON()
    if jsonStr == "" {
        return s.fallbackUnderstand(query), nil
    }
    
    var plan QueryPlan
    if err := json.Unmarshal([]byte(jsonStr), &plan); err != nil {
        return s.fallbackUnderstand(query), nil
    }
    
    // éªŒè¯å¹¶ä¿®æ­£
    plan = s.validateAndFix(&plan, query)
    
    // å‘é€å®Œæˆäº‹ä»¶
    progressCh <- UnderstandProgress{
        Stage:   "done",
        Message: "ç†è§£å®Œæˆ",
    }
    
    return &plan, nil
}
```

### 6.3 Fallback æœºåˆ¶

å½“ LLM è°ƒç”¨å¤±è´¥æ—¶ï¼Œå›é€€åˆ°åŸºäºè§„åˆ™çš„ç†è§£ï¼š

```go
func (s *QueryUnderstandingService) fallbackUnderstand(query string) *QueryPlan {
    // åŸºäºè§„åˆ™çš„ç®€å•åˆ†ç±»ï¼ˆå¤ç”¨ç°æœ‰ Query Routing é€»è¾‘ï¼‰
    intent := "semantic"
    denseWeight := float32(0.7)
    
    // æ£€æµ‹æƒ…ç»ªè¯
    for _, word := range EmotionWords {
        if strings.Contains(query, word) {
            intent = "emotion"
            denseWeight = 0.8
            break
        }
    }
    
    // æ£€æµ‹ä¸»ä½“è¯
    for _, subject := range []string{"ç†ŠçŒ«å¤´", "è˜‘è‡å¤´", "çŒ«å’ª", "æŸ´çŠ¬"} {
        if strings.Contains(query, subject) {
            if intent == "emotion" {
                intent = "composite"
                denseWeight = 0.6
            } else {
                intent = "subject"
                denseWeight = 0.5
            }
            break
        }
    }
    
    return &QueryPlan{
        Intent:        QueryIntent(intent),
        SemanticQuery: query, // ç›´æ¥ä½¿ç”¨åŸå§‹æŸ¥è¯¢
        Keywords:      []string{query},
        Strategy: SearchStrategy{
            DenseWeight:    denseWeight,
            NeedExactMatch: len([]rune(query)) <= 4,
        },
    }
}
```

### 6.4 è¾“å‡ºéªŒè¯

```go
func (s *QueryUnderstandingService) validateAndFix(plan *QueryPlan, originalQuery string) *QueryPlan {
    // 1. éªŒè¯ Intent
    validIntents := map[QueryIntent]bool{
        "emotion": true, "meme": true, "subject": true,
        "scene": true, "action": true, "text": true, "composite": true,
    }
    if !validIntents[plan.Intent] {
        plan.Intent = "semantic"
    }
    
    // 2. éªŒè¯ DenseWeight èŒƒå›´
    if plan.Strategy.DenseWeight < 0 {
        plan.Strategy.DenseWeight = 0
    }
    if plan.Strategy.DenseWeight > 1 {
        plan.Strategy.DenseWeight = 1
    }
    
    // 3. éªŒè¯ SemanticQuery é•¿åº¦
    if len([]rune(plan.SemanticQuery)) < 10 {
        plan.SemanticQuery = originalQuery
    }
    if len([]rune(plan.SemanticQuery)) > 200 {
        plan.SemanticQuery = string([]rune(plan.SemanticQuery)[:200])
    }
    
    // 4. éªŒè¯ Keywords
    if len(plan.Keywords) == 0 {
        plan.Keywords = []string{originalQuery}
    }
    if len(plan.Keywords) > 5 {
        plan.Keywords = plan.Keywords[:5]
    }
    
    // 5. éªŒè¯ Synonyms
    if len(plan.Synonyms) > 5 {
        plan.Synonyms = plan.Synonyms[:5]
    }
    
    return plan
}
```

### 6.5 ç¼“å­˜ç­–ç•¥

```go
type QueryPlanCache struct {
    cache *lru.Cache // ä½¿ç”¨ LRU ç¼“å­˜
    ttl   time.Duration
}

type cachedPlan struct {
    plan      *QueryPlan
    timestamp time.Time
}

func (c *QueryPlanCache) Get(query string) (*QueryPlan, bool) {
    key := normalizeQuery(query)
    if cached, ok := c.cache.Get(key); ok {
        cp := cached.(*cachedPlan)
        if time.Since(cp.timestamp) < c.ttl {
            return cp.plan, true
        }
        c.cache.Remove(key)
    }
    return nil, false
}

func (c *QueryPlanCache) Set(query string, plan *QueryPlan) {
    key := normalizeQuery(query)
    c.cache.Add(key, &cachedPlan{
        plan:      plan,
        timestamp: time.Now(),
    })
}

func normalizeQuery(query string) string {
    // å»é™¤ç©ºæ ¼ã€è½¬å°å†™
    return strings.ToLower(strings.TrimSpace(query))
}
```

---

## 7. æœªæ¥æ‰©å±•

### 7.1 å¤šè½®å¯¹è¯æ”¯æŒ

```
æœªæ¥å¯ä»¥æ”¯æŒä¸Šä¸‹æ–‡ç†è§£:

ç”¨æˆ·: "ç†ŠçŒ«å¤´"
ç³»ç»Ÿ: [è¿”å›ç†ŠçŒ«å¤´è¡¨æƒ…åŒ…]
ç”¨æˆ·: "æ— è¯­çš„"
ç³»ç»Ÿ: [ç†è§£ä¸º "ç†ŠçŒ«å¤´æ— è¯­"ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„ "æ— è¯­"]
```

### 7.2 ä¸ªæ€§åŒ–ç†è§£

```
ç»“åˆç”¨æˆ·å†å²:
- ç”¨æˆ·åå¥½çš„ä¸»ä½“ç±»å‹
- ç”¨æˆ·å¸¸ç”¨çš„æƒ…ç»ªè¯
- è°ƒæ•´ dense_weight åå¥½
```

### 7.3 å¤šæ¨¡æ€æŸ¥è¯¢

```
æ”¯æŒå›¾ç‰‡è¾“å…¥:
ç”¨æˆ·: [ä¸Šä¼ ä¸€å¼ è¡¨æƒ…åŒ…å›¾ç‰‡] "ç±»ä¼¼è¿™ç§"
ç³»ç»Ÿ:
  1. ç”¨ VLM ç†è§£å›¾ç‰‡å†…å®¹
  2. æå–å…³é”®ç‰¹å¾
  3. ç”Ÿæˆ QueryPlan
```

### 7.4 æŸ¥è¯¢å»ºè®®

```
åŸºäº QueryPlan ç”Ÿæˆç›¸å…³æŸ¥è¯¢å»ºè®®:

ç”¨æˆ·: "æ— è¯­"
QueryPlan.intent = "emotion"
å»ºè®®: ["æ— å¥ˆ", "å«Œå¼ƒ", "ç¿»ç™½çœ¼", "ç†ŠçŒ«å¤´æ— è¯­"]
```

---

## 8. å‚è€ƒèµ„æ–™

- [Qdrant Hybrid Search](https://qdrant.tech/documentation/concepts/hybrid-queries/)
- [Query Understanding in Search](https://www.pinecone.io/learn/query-understanding/)
- [OpenAI JSON Mode](https://platform.openai.com/docs/guides/structured-outputs)
